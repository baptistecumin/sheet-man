<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sheet-Man</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 656 656'%3E%3Crect width='656' height='656' rx='60' fill='white'/%3E%3Cpath d='M259.891 249.609C167.663 278.785 119.681 228.948 124.306 134.828C126.734 111.779 143.355 104.998 165.763 104.744C217.019 104.089 277.821 104.681 328.423 104.491C433.195 99.0821 526.274 144 528.323 250.962C529.217 297.629 511.822 341.869 482.741 376.813C465.487 397.77 468.908 417.503 481.559 438.989C494.821 463.179 517.018 493.791 528.274 518.446C540.418 543.206 528.401 549.903 500.904 551.594C473.047 552.988 438.18 552.946 409.859 551.678C387.916 550.896 370.007 543.164 363.101 521.594C353.492 496.199 346.079 464.615 327.684 442.749C313.851 424.348 281.982 408.545 266.121 430.538C241.602 462.946 298.898 527.065 265.657 546.227C242.806 555.481 182.785 555.143 162.257 544.495C137.484 530.467 144.981 488.678 143.566 463.812C144.284 430.622 141.919 396.714 149.311 364.073C180.863 215.933 379.574 374.447 415.329 268.729C418.729 246.715 398.729 229.771 378.581 225.652C337.356 216.462 299.574 238.666 259.976 249.588L259.891 249.609Z' fill='%230817EC'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --blue: #2563eb;
            --blue-dark: #1d4ed8;
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-800: #1e293b;
            --slate-900: #0f172a;
            --green: #22c55e;
            --red: #ef4444;
            --yellow: #eab308;
            --radius: 16px;
        }
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--slate-100);
            min-height: 100vh;
            min-height: 100dvh;
            overflow: hidden;
            touch-action: none;
            -webkit-user-select: none;
            user-select: none;
        }
        .screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 24px;
            background: var(--slate-100);
        }
        .logo {
            width: 48px;
            height: 48px;
            margin-bottom: 8px;
        }
        .title {
            font-size: 28px;
            font-weight: 700;
            color: var(--slate-900);
            letter-spacing: -0.03em;
        }
        .tagline {
            color: var(--slate-400);
            font-size: 13px;
            margin-top: 4px;
        }
        .btn {
            background: var(--blue);
            color: #fff;
            border: none;
            height: 48px;
            padding: 0 32px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            margin-top: 24px;
        }
        .btn:active { transform: scale(0.97); background: var(--blue-dark); }
        .hidden { display: none !important; }

        /* Leaderboard Card */
        .card {
            background: #fff;
            border-radius: var(--radius);
            padding: 20px;
            width: 100%;
            max-width: 300px;
            margin-top: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--slate-400);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-bottom: 16px;
        }
        .lb-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            font-size: 14px;
        }
        .lb-row:not(:last-child) { border-bottom: 1px solid var(--slate-100); }
        .lb-rank {
            width: 28px;
            height: 28px;
            background: var(--slate-100);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: var(--slate-500);
            margin-right: 12px;
        }
        .lb-rank.gold { background: #fef3c7; color: #b45309; }
        .lb-rank.silver { background: var(--slate-200); color: var(--slate-600); }
        .lb-rank.bronze { background: #fed7aa; color: #c2410c; }
        .lb-name { flex: 1; color: var(--slate-800); font-weight: 500; }
        .lb-score { color: var(--blue); font-weight: 600; }

        /* Game Screen */
        #game-container {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            background: var(--slate-100);
        }
        .game-header {
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .score-display {
            font-size: 15px;
            font-weight: 600;
            color: var(--slate-800);
        }
        .score-display span { color: var(--blue); }
        .power-badge {
            background: var(--green);
            color: #fff;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .power-badge.active { opacity: 1; }
        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            position: relative;
        }
        canvas {
            background: #fff;
            border-radius: var(--radius);
            box-shadow: 0 4px 24px rgba(0,0,0,0.06);
        }

        /* Touch Controls */
        .touch-layer {
            position: absolute;
            inset: 0;
            display: grid;
            grid-template: 1fr 1fr 1fr / 1fr 1fr 1fr;
            pointer-events: none;
        }
        .touch-zone {
            pointer-events: auto;
            border-radius: 8px;
            transition: background 0.1s;
        }
        .touch-zone:active { background: rgba(37, 99, 235, 0.08); }
        .tz-up { grid-area: 1 / 2; }
        .tz-down { grid-area: 3 / 2; }
        .tz-left { grid-area: 2 / 1; }
        .tz-right { grid-area: 2 / 3; }

        /* Game Over */
        #gameover-screen {
            background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
            color: #fff;
            display: none;
        }
        #gameover-screen .logo { filter: brightness(0) invert(1); }
        #gameover-screen .title { color: #fff; }
        .final-score {
            font-size: 48px;
            font-weight: 700;
            margin: 8px 0 4px;
        }
        .final-label {
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            font-weight: 500;
        }
        .name-input {
            width: 200px;
            height: 48px;
            padding: 0 16px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-family: inherit;
            font-size: 15px;
            text-align: center;
            margin-top: 24px;
        }
        .name-input::placeholder { color: rgba(255,255,255,0.5); }
        .name-input:focus { outline: none; border-color: rgba(255,255,255,0.5); }
        .btn-row { display: flex; gap: 12px; margin-top: 16px; }
        .btn-ghost {
            background: rgba(255,255,255,0.15);
            color: #fff;
            border: none;
            height: 48px;
            padding: 0 24px;
            font-size: 15px;
            font-weight: 600;
            font-family: inherit;
            border-radius: 12px;
            cursor: pointer;
        }
        .btn-white {
            background: #fff;
            color: var(--blue);
        }
        .cta-text {
            margin-top: 40px;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        .cta-text a { color: rgba(255,255,255,0.8); }
    </style>
</head>
<body>
    <div id="start-screen" class="screen">
        <svg class="logo" viewBox="0 0 656 656" fill="none">
            <rect width="656" height="656" rx="60" fill="#fff"/>
            <path d="M259.891 249.609C167.663 278.785 119.681 228.948 124.306 134.828C126.734 111.779 143.355 104.998 165.763 104.744C217.019 104.089 277.821 104.681 328.423 104.491C433.195 99.0821 526.274 144 528.323 250.962C529.217 297.629 511.822 341.869 482.741 376.813C465.487 397.77 468.908 417.503 481.559 438.989C494.821 463.179 517.018 493.791 528.274 518.446C540.418 543.206 528.401 549.903 500.904 551.594C473.047 552.988 438.18 552.946 409.859 551.678C387.916 550.896 370.007 543.164 363.101 521.594C353.492 496.199 346.079 464.615 327.684 442.749C313.851 424.348 281.982 408.545 266.121 430.538C241.602 462.946 298.898 527.065 265.657 546.227C242.806 555.481 182.785 555.143 162.257 544.495C137.484 530.467 144.981 488.678 143.566 463.812C144.284 430.622 141.919 396.714 149.311 364.073C180.863 215.933 379.574 374.447 415.329 268.729C418.729 246.715 398.729 229.771 378.581 225.652C337.356 216.462 299.574 238.666 259.976 249.588L259.891 249.609Z" fill="#2563eb"/>
        </svg>
        <h1 class="title">Sheet-Man</h1>
        <p class="tagline">Clean the data. Avoid the spreadsheets.</p>
        <button class="btn" onclick="startGame()">Play</button>
        <div class="card">
            <div class="card-title">Top Scores</div>
            <div id="leaderboard"></div>
        </div>
    </div>

    <div id="gameover-screen" class="screen">
        <svg class="logo" viewBox="0 0 656 656" fill="none">
            <rect width="656" height="656" rx="60" fill="#fff"/>
            <path d="M259.891 249.609C167.663 278.785 119.681 228.948 124.306 134.828C126.734 111.779 143.355 104.998 165.763 104.744C217.019 104.089 277.821 104.681 328.423 104.491C433.195 99.0821 526.274 144 528.323 250.962C529.217 297.629 511.822 341.869 482.741 376.813C465.487 397.77 468.908 417.503 481.559 438.989C494.821 463.179 517.018 493.791 528.274 518.446C540.418 543.206 528.401 549.903 500.904 551.594C473.047 552.988 438.18 552.946 409.859 551.678C387.916 550.896 370.007 543.164 363.101 521.594C353.492 496.199 346.079 464.615 327.684 442.749C313.851 424.348 281.982 408.545 266.121 430.538C241.602 462.946 298.898 527.065 265.657 546.227C242.806 555.481 182.785 555.143 162.257 544.495C137.484 530.467 144.981 488.678 143.566 463.812C144.284 430.622 141.919 396.714 149.311 364.073C180.863 215.933 379.574 374.447 415.329 268.729C418.729 246.715 398.729 229.771 378.581 225.652C337.356 216.462 299.574 238.666 259.976 249.588L259.891 249.609Z" fill="#2563eb"/>
        </svg>
        <p class="final-label">Score</p>
        <p class="final-score" id="final-score">0</p>
        <input type="text" class="name-input" id="player-name" placeholder="Your name" maxlength="15">
        <div class="btn-row">
            <button class="btn-ghost" onclick="skipSubmit()">Skip</button>
            <button class="btn-ghost btn-white" onclick="submitScore()">Save</button>
        </div>
        <button id="retry-btn" class="btn hidden" style="margin-top:16px" onclick="startGame()">Play Again</button>
        <p class="cta-text">Stop playing with spreadsheets. <a href="https://rastro.ai" target="_blank">Try Rastro</a></p>
    </div>

    <div id="game-container" class="hidden">
        <div class="game-header">
            <span class="score-display"><span id="score-value">0</span> SKUs</span>
            <span class="power-badge" id="power-badge">POWERED</span>
        </div>
        <div class="game-area">
            <canvas id="canvas"></canvas>
            <div class="touch-layer">
                <div class="touch-zone tz-up" data-dir="up"></div>
                <div class="touch-zone tz-left" data-dir="left"></div>
                <div class="touch-zone tz-right" data-dir="right"></div>
                <div class="touch-zone tz-down" data-dir="down"></div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://pkbcifdmebszcrpmlhxm.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBrYmNpZmRtZWJzemNycG1saHhtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTQ0MzkwMCwiZXhwIjoyMDgxMDE5OTAwfQ.oxMxEUp7svTv_AXJC0-cLUWE7nOt5p_u2Ahxxiv98Fk';

        const CELL = 16, COLS = 19, ROWS = 21;
        const MAP = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,2,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,2,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,1,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,1,1],
            [1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,1,1,1],
            [1,1,1,1,0,1,0,1,1,0,1,1,0,1,0,1,1,1,1],
            [0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0],
            [1,1,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,1,1],
            [1,1,1,1,0,1,0,0,0,0,0,0,0,1,0,1,1,1,1],
            [1,1,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],
            [1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],
            [1,2,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,2,1],
            [1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],
            [1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],
            [1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        ];

        let canvas, ctx, player, enemies, dots, powerUps, score = 0, gameRunning = false, powered = false, powerTimer, animFrame, finalScore = 0;

        const ENEMIES = [
            { name: 'XLS', color: '#22c55e', speed: 3 },
            { name: 'PDF', color: '#ef4444', speed: 2 },
            { name: 'ERP', color: '#64748b', speed: 1 },
            { name: 'ZIP', color: '#eab308', speed: 2 },
        ];

        async function fetchLeaderboard() {
            try {
                const res = await fetch(`${SUPABASE_URL}/rest/v1/sheetman_leaderboard?select=name,score&order=score.desc&limit=5`, {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
                });
                if (!res.ok) throw new Error();
                renderLeaderboard(await res.json());
            } catch { renderLeaderboard([]); }
        }

        function renderLeaderboard(data) {
            const el = document.getElementById('leaderboard');
            if (!data?.length) { el.innerHTML = '<div class="lb-row"><span style="color:var(--slate-400)">No scores yet</span></div>'; return; }
            const ranks = ['gold', 'silver', 'bronze'];
            el.innerHTML = data.map((e, i) => `
                <div class="lb-row">
                    <div class="lb-rank ${ranks[i] || ''}">${i + 1}</div>
                    <span class="lb-name">${escapeHtml(e.name)}</span>
                    <span class="lb-score">${e.score}</span>
                </div>
            `).join('');
        }

        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }

        async function saveScore(name, score) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/sheetman_leaderboard`, {
                    method: 'POST',
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`, 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ name, score })
                });
                fetchLeaderboard();
            } catch {}
        }

        function submitScore() {
            const name = document.getElementById('player-name').value.trim() || 'Anon';
            saveScore(name, finalScore);
            document.querySelector('.name-input').style.display = 'none';
            document.querySelector('.btn-row').style.display = 'none';
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        function skipSubmit() {
            document.querySelector('.name-input').style.display = 'none';
            document.querySelector('.btn-row').style.display = 'none';
            document.getElementById('retry-btn').classList.remove('hidden');
        }

        function init() {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            const maxW = Math.min(window.innerWidth - 32, 360);
            const maxH = window.innerHeight - 100;
            const scale = Math.min(maxW / (COLS * CELL), maxH / (ROWS * CELL));
            canvas.width = COLS * CELL;
            canvas.height = ROWS * CELL;
            canvas.style.width = (COLS * CELL * scale) + 'px';
            canvas.style.height = (ROWS * CELL * scale) + 'px';
            setupControls();
            fetchLeaderboard();
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('gameover-screen').style.display = 'none';
            document.getElementById('game-container').classList.remove('hidden');
            document.querySelector('.name-input').style.display = '';
            document.querySelector('.btn-row').style.display = '';
            document.getElementById('retry-btn').classList.add('hidden');

            score = 0; powered = false;
            if (powerTimer) clearTimeout(powerTimer);
            player = { x: 9, y: 15, dx: 0, dy: 0, nextDx: 0, nextDy: 0 };
            enemies = ENEMIES.map((cfg, i) => ({ ...cfg, x: 8 + i, y: 9, dx: Math.random() > 0.5 ? 1 : -1, dy: 0, mc: 0 }));
            dots = []; powerUps = [];
            for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) {
                if (MAP[y][x] === 0) dots.push({ x, y });
                if (MAP[y][x] === 2) powerUps.push({ x, y });
            }
            updateScore();
            gameRunning = true;
            if (animFrame) cancelAnimationFrame(animFrame);
            gameLoop();
        }

        function setupControls() {
            document.addEventListener('keydown', e => {
                if (!gameRunning) return;
                const keys = { ArrowUp: [0,-1], ArrowDown: [0,1], ArrowLeft: [-1,0], ArrowRight: [1,0], w: [0,-1], s: [0,1], a: [-1,0], d: [1,0] };
                if (keys[e.key]) { [player.nextDx, player.nextDy] = keys[e.key]; e.preventDefault(); }
            });
            document.querySelectorAll('.touch-zone').forEach(z => {
                z.addEventListener('touchstart', e => {
                    if (!gameRunning) return;
                    e.preventDefault();
                    const dirs = { up: [0,-1], down: [0,1], left: [-1,0], right: [1,0] };
                    [player.nextDx, player.nextDy] = dirs[z.dataset.dir];
                }, { passive: false });
            });
            document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
        }

        function canMove(x, y) {
            if (x < 0 || x >= COLS) return true;
            if (y < 0 || y >= ROWS) return false;
            return MAP[y][x] !== 1;
        }

        function movePlayer() {
            if (canMove(player.x + player.nextDx, player.y + player.nextDy)) {
                player.dx = player.nextDx; player.dy = player.nextDy;
            }
            if (canMove(player.x + player.dx, player.y + player.dy)) {
                player.x += player.dx; player.y += player.dy;
            }
            if (player.x < 0) player.x = COLS - 1;
            if (player.x >= COLS) player.x = 0;

            let idx = dots.findIndex(d => d.x === player.x && d.y === player.y);
            if (idx !== -1) { dots.splice(idx, 1); score += 10; updateScore(); }
            idx = powerUps.findIndex(p => p.x === player.x && p.y === player.y);
            if (idx !== -1) { powerUps.splice(idx, 1); score += 50; updateScore(); activatePower(); }
            if (!dots.length && !powerUps.length) { score += 500; gameOver(); }
        }

        function activatePower() {
            powered = true;
            document.getElementById('power-badge').classList.add('active');
            if (powerTimer) clearTimeout(powerTimer);
            powerTimer = setTimeout(() => { powered = false; document.getElementById('power-badge').classList.remove('active'); }, 5000);
        }

        function moveEnemies() {
            enemies.forEach(e => {
                if (++e.mc < 4 - e.speed) return;
                e.mc = 0;
                const dirs = [[0,-1],[0,1],[-1,0],[1,0]].filter(d => canMove(e.x+d[0], e.y+d[1]) && !(d[0]===-e.dx && d[1]===-e.dy));
                if (dirs.length) {
                    dirs.sort((a,b) => {
                        const dA = Math.abs(player.x-(e.x+a[0])) + Math.abs(player.y-(e.y+a[1]));
                        const dB = Math.abs(player.x-(e.x+b[0])) + Math.abs(player.y-(e.y+b[1]));
                        return powered ? dB - dA : dA - dB;
                    });
                    const c = Math.random() > 0.3 ? dirs[0] : dirs[Math.floor(Math.random()*dirs.length)];
                    e.dx = c[0]; e.dy = c[1];
                }
                if (canMove(e.x + e.dx, e.y + e.dy)) { e.x += e.dx; e.y += e.dy; }
                if (e.x < 0) e.x = COLS - 1;
                if (e.x >= COLS) e.x = 0;
            });
        }

        function checkCollision() {
            enemies.forEach(e => {
                if (e.x === player.x && e.y === player.y) {
                    if (powered) { e.x = 9; e.y = 9; score += 200; updateScore(); }
                    else gameOver();
                }
            });
        }

        function gameOver() {
            gameRunning = false;
            finalScore = score;
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('final-score').textContent = score;
            document.getElementById('gameover-screen').style.display = 'flex';
            document.getElementById('player-name').value = '';
        }

        function updateScore() { document.getElementById('score-value').textContent = score; }

        function draw() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Subtle grid
            ctx.strokeStyle = '#f1f5f9';
            for (let x = 0; x <= COLS; x++) { ctx.beginPath(); ctx.moveTo(x*CELL, 0); ctx.lineTo(x*CELL, canvas.height); ctx.stroke(); }
            for (let y = 0; y <= ROWS; y++) { ctx.beginPath(); ctx.moveTo(0, y*CELL); ctx.lineTo(canvas.width, y*CELL); ctx.stroke(); }

            // Walls with rounded corners
            ctx.fillStyle = '#1e293b';
            for (let y = 0; y < ROWS; y++) for (let x = 0; x < COLS; x++) {
                if (MAP[y][x] === 1) {
                    ctx.beginPath();
                    ctx.roundRect(x*CELL+1, y*CELL+1, CELL-2, CELL-2, 3);
                    ctx.fill();
                }
            }

            // Dots
            ctx.fillStyle = '#cbd5e1';
            dots.forEach(d => { ctx.beginPath(); ctx.arc(d.x*CELL+CELL/2, d.y*CELL+CELL/2, 2, 0, Math.PI*2); ctx.fill(); });

            // Power-ups
            ctx.fillStyle = '#2563eb';
            powerUps.forEach(p => { ctx.beginPath(); ctx.arc(p.x*CELL+CELL/2, p.y*CELL+CELL/2, 5, 0, Math.PI*2); ctx.fill(); });

            // Player
            ctx.fillStyle = powered ? '#22c55e' : '#2563eb';
            ctx.beginPath();
            ctx.arc(player.x*CELL+CELL/2, player.y*CELL+CELL/2, CELL/2-1, 0, Math.PI*2);
            ctx.fill();

            // Enemies
            enemies.forEach(e => {
                ctx.fillStyle = powered ? '#e2e8f0' : e.color;
                ctx.beginPath();
                ctx.roundRect(e.x*CELL+2, e.y*CELL+2, CELL-4, CELL-4, 4);
                ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 7px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(e.name, e.x*CELL+CELL/2, e.y*CELL+CELL/2+2.5);
            });
        }

        let lastTime = 0;
        function gameLoop(ts = 0) {
            if (!gameRunning) return;
            if (ts - lastTime >= 130) { movePlayer(); moveEnemies(); checkCollision(); lastTime = ts; }
            draw();
            animFrame = requestAnimationFrame(gameLoop);
        }

        init();
    </script>
</body>
</html>
